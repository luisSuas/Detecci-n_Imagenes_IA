{% extends "base.html" %}

{% block title %}Cámara en Vivo{% endblock %}

{% block head %}
<style>
    #video-container { position: relative; max-width: 800px; margin: 0 auto; }
    #video-feed { width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); background:#000; }
    .alert-mode { border: 3px solid #dc3545; animation: alert-pulse .5s infinite alternate; }
    @keyframes alert-pulse { from { box-shadow: 0 0 5px #dc3545; } to { box-shadow: 0 0 30px #dc3545; } }
    #alert-indicator { position:absolute; top:20px; left:20px; right:20px; z-index:10; display:none; }
    #controls { max-width: 800px; margin: 20px auto 0; }
    .camera-selector { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    .log-container { max-width: 800px; margin: 30px auto 0; max-height: 200px; overflow-y: auto; }
    .log-entry { padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; font-size: .9rem; }
    .log-alert { background-color:#f8d7da; border-left:4px solid #dc3545; }
    .log-info  { background-color:#e2e3e5; border-left:4px solid #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 text-center mb-4">
        <h1 class="display-5">Monitoreo en Tiempo Real</h1>
        <p class="lead">Detección instantánea de objetos peligrosos</p>
    </div>

    <div class="camera-selector">
        <select id="camera-select" class="form-select">
            <option value="0">Cámara Local</option>
            <option value="1">Cámara 1</option>
            <option value="2">Cámara 2</option>
            <option value="3">Cámara 3</option>
            <option value="4">Cámara 4</option>
            <option value="5">Cámara 5</option>
            <option value="6">Cámara 6</option>
            <option value="7">Cámara 7</option>
            <option value="8">Cámara 8</option>
            <option value="9">Cámara 9</option>
            <option value="10">Cámara 10</option>
        </select>
        <button id="switch-camera-btn" class="btn btn-primary">
            <i class="bi bi-camera-video me-2"></i>Cambiar Cámara
        </button>
    </div>

    <div id="video-container">
        <div class="alert alert-danger text-center" id="alert-indicator">
            <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>¡ALERTA!</strong> Objeto peligroso detectado
        </div>
        <img id="video-feed" alt="video en vivo">
    </div>

    <div id="controls" class="d-flex justify-content-center gap-3 mt-4">
        <button id="btn-back" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-2"></i>Volver
        </button>
        <button id="pause-btn" class="btn btn-warning">
            <i class="bi bi-pause me-2"></i>Pausar
        </button>
        <button id="btn-reload" class="btn btn-danger">
            <i class="bi bi-arrow-clockwise me-2"></i>Reiniciar
        </button>
        <button id="snapshot-btn" class="btn btn-info">
            <i class="bi bi-camera me-2"></i>Capturar
        </button>
    </div>

    <div class="log-container mt-4">
        <h5 class="mb-3"><i class="bi bi-list-check me-2"></i>Registro de Eventos</h5>
        <div id="event-log">
            <div class="log-entry log-info">
                <i class="bi bi-info-circle me-2"></i>Sistema iniciado - Monitoreo activo
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Root path seguro (soporta subpath como /ai-seguridad)
    const ROOT = "{{ request.scope.get('root_path','') }}";

    const video          = document.getElementById('video-feed');
    const alertIndicator = document.getElementById('alert-indicator');
    const pauseBtn       = document.getElementById('pause-btn');
    const snapshotBtn    = document.getElementById('snapshot-btn');
    const switchBtn      = document.getElementById('switch-camera-btn');
    const cameraSelect   = document.getElementById('camera-select');
    const eventLog       = document.getElementById('event-log');

    // Botones que dependen del ROOT
    document.getElementById('btn-back').addEventListener('click', () => {
        location.href = (ROOT || '/') + '/';
    });
    document.getElementById('btn-reload').addEventListener('click', () => location.reload());

    let websocket;
    let isPaused        = false;
    let alertActive     = false;
    let lastAlertTime   = 0;
    let currentCameraId = 0;
    let lastObjectUrl   = null;

    function wsUrl(cameraId){
        const proto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
        // Respetar subpath: ws://host{ROOT}/ws/{id}
        const base  = `${proto}//${location.host}${ROOT || ''}`;
        return `${base}/ws/${cameraId}`;
    }

    // Conectar a WebSocket
    function connectWebSocket(cameraId) {
        try { if (websocket && websocket.readyState === WebSocket.OPEN) websocket.close(1000, 'switching camera'); } catch(_) {}

        currentCameraId = cameraId;
        websocket = new WebSocket(wsUrl(cameraId));
        websocket.binaryType = 'arraybuffer'; // recibir frames como ArrayBuffer

        websocket.onopen = () => addLog(`Cámara ${cameraId} conectada`, "info");

        websocket.onmessage = (event) => {
            if (isPaused) return;

            const data = event.data;

            // Mensajes de texto → alerta o meta-eventos
            if (typeof data === 'string') {
                if (isAlertMessage(data)) showAlert();
                return;
            }

            // Binario → pintar frame
            let blob;
            if (data instanceof ArrayBuffer) {
                blob = new Blob([data], { type: 'image/jpeg' });
            } else if (data instanceof Blob) {
                blob = data;
            } else {
                return; // tipo no esperado
            }

            try { if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl); } catch(_) {}
            lastObjectUrl = URL.createObjectURL(blob);
            video.src = lastObjectUrl;
        };

        websocket.onclose = () => {
            addLog(`Cámara ${cameraId} desconectada`, "info");
            setTimeout(() => connectWebSocket(cameraId), 2000);
        };

        websocket.onerror = () => addLog(`Error en cámara ${cameraId}`, "alert");
    }

    // Detectar si el texto recibido es una alerta (JSON o texto plano)
    function isAlertMessage(text) {
        if (!text) return false;
        if (text.trim().startsWith('{')) {
            try {
                const j = JSON.parse(text);
                if (j && (j.alert === true || j.type === 'alert' || j.level === 'danger')) return true;
            } catch (_) {}
        }
        return String(text).toUpperCase().includes('ALERTA');
    }

    // Mostrar alerta visual + sonido + log
    function showAlert() {
        const now = Date.now();
        if (now - lastAlertTime < 5000) return; // anti-spam

        lastAlertTime = now;
        alertActive   = true;
        video.classList.add('alert-mode');
        alertIndicator.style.display = 'block';

        try {
            const audio = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3");
            audio.play().catch(()=>{});
        } catch (_) {}

        addLog(`¡Alerta en Cámara ${currentCameraId}! Objeto peligroso detectado`, "alert");

        setTimeout(() => {
            alertActive = false;
            video.classList.remove('alert-mode');
            alertIndicator.style.display = 'none';
        }, 3000);
    }

    // Añadir entrada al registro
    function addLog(message, type) {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;
        logEntry.innerHTML = `
            <i class="bi ${type === 'alert' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
            ${new Date().toLocaleTimeString()} - ${message}
        `;
        eventLog.prepend(logEntry);
        if (eventLog.children.length > 10) eventLog.removeChild(eventLog.lastChild);
    }

    // Botón de pausa
    pauseBtn.addEventListener('click', () => {
        isPaused = !isPaused;
        if (isPaused) {
            pauseBtn.innerHTML = '<i class="bi bi-play me-2"></i>Reanudar';
            pauseBtn.classList.remove('btn-warning');
            pauseBtn.classList.add('btn-success');
            addLog("Monitoreo pausado", "info");
        } else {
            pauseBtn.innerHTML = '<i class="bi bi-pause me-2"></i>Pausar';
            pauseBtn.classList.remove('btn-success');
            pauseBtn.classList.add('btn-warning');
            addLog("Monitoreo reanudado", "info");
        }
    });

    // Botón de captura
    snapshotBtn.addEventListener('click', () => {
        if (video.src) {
            const link = document.createElement('a');
            link.href = video.src;
            link.download = `captura-cam${currentCameraId}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            addLog(`Captura de Cámara ${currentCameraId} guardada`, "info");
        }
    });

    // Botón para cambiar de cámara
    switchBtn.addEventListener('click', () => {
        const newCameraId = parseInt(cameraSelect.value, 10);
        if (newCameraId !== currentCameraId) {
            addLog(`Cambiando a Cámara ${newCameraId}`, "info");
            connectWebSocket(newCameraId);
        }
    });

    // Iniciar cámara local por defecto
    document.addEventListener('DOMContentLoaded', () => connectWebSocket(0));

    // Limpieza al salir
    window.addEventListener('beforeunload', () => {
        try { if (websocket) websocket.close(1000, 'leaving'); } catch(_) {}
        try { if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl); } catch(_) {}
    });
</script>
{% endblock %}
